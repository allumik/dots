# General outline of the NixOS configuration

This file outlines the general structure of the `/etc/nixos/` configuration files. It is not a complete configuration but serves as a guide to understanding how I manage my NixOS setup.

----

The general structure for `nixos/` is as follows:

```
.
├── flake.nix
├── flake.lock
├── README.md
├── hosts/
│   ├── base.nix
│   ├── common.nix
│   ├── deskmeat/
│   │   ├── configuration.nix
│   │   └── hardware-configuration.nix
│   └── old_lenno/
│       ├── configuration.nix
│       └── hardware-configuration.nix
└── overlays/
    └── default.nix
```

And for the home-manager configurations, just separate users into their own directories, for example `./home-manager/allu/home.nix` and `./home-manager/allu-wsl/home.nix` etc.

**`TODO:`** replace `base.nix` and `common.nix` with a more modular system imported in `flake.nix`. Still, keep them monolithic, for **personal** management I prefer larger documents.

## Component Explanation

  * **`flake.nix`**: The entry point for the NixOS configurations. Its primary role is to define the `nixpkgs` input and build the `nixosConfigurations` output for each host.
  * **`/hosts`**: This directory isolates all machine-specific configurations.
      * `common.nix`: A file for configuration options that are identical across all machines. This adheres to the "Don't Repeat Yourself" (DRY) principle for universal settings like timezone, default shell, or system-wide Nix settings.
      * `base.nix`: Similar to `common.nix`, but for settings that are very minimally basic, such as some editor preferences, localisation and some basic tools.
      * `hosts/<machine-name>/configuration.nix`: The primary, monolithic configuration file for a specific machine. It imports `./hardware-configuration.nix` and `../../common.nix` and contains the majority of the system's definition, including packages, services, and users.
      * `hosts/<machine-name>/hardware-configuration.nix`: The machine-specific hardware profile generated by NixOS.
  * **`/overlays`** (Optional): This directory is for Nixpkgs overlays, which are used to add custom packages or modify existing ones. The `default.nix` in this directory can be imported into the `flake.nix` and applied to the `nixpkgs` input.

## Setting Up a New Machine

0. Install NixOS.

1. Copy the configuration files.

```
# NB! clone repo and navigate to it
sudo mv /etc/nixos/ /etc/nixos_bp/ # backup the initial configuration
sudo cp -R ./nixos/ /etc/ # copy the nixos conf files
cp -R ./home-manager $XDG_CONFIG_HOME # copy home manager config to ~/.config/ (usually)
```

2. [Install standalone home-manager](https://home-manager.dev/manual/25.05/index.xhtml#sec-install-standalone) and plasma manager with channels in you userspace.

```
nix-channel --add https://github.com/nix-community/home-manager/archive/master.tar.gz home-manager
nix-channel --add https://github.com/nix-community/plasma-manager/archive/trunk.tar.gz plasma-manager
nix-channel --update
```

3. Installation

Check & compare the initial configuration and the new one. If this is a new host, create a new configuration in `./hosts/`, otherwise just start the installation:

```
cd /etc/nixos/
sudo nix flake update
sudo nixos-rebuild switch --flake /etc/nixos/.#deskmeat # replace with your hostname
```

And for the `home-manager` configuration:

```
home-manager switch
```

## Setting Up My User Preferences

Some steps need to be performed with a new blank plasma user:

* Go to Plasma settings and download the "Commonality" global theme, "Bibata-Modern-Ice.gz" cursor theme, "Memphis98" icon theme and set the application style to MS Windows 9x. In Application Style, also configure the GTK style to "Irixium".

	* `TODO:` Look into automating some steps of this process: https://github.com/nix-community/plasma-manager/issues/212

* Set up mail accounts in Thunderbird.